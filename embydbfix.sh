#!/bin/bash

# =========================================================================================
# ğŸ¯ é€šç”¨ Emby æ•°æ®åº“ä¿®å¤è„šæœ¬ (v1.0)
# 
# æè¿°: ä¿®å¤å› å…¨æ–‡æœç´¢ (fts) ç´¢å¼•æŸåå¯¼è‡´çš„ Emby æ•°æ®åº“å¯åŠ¨å¤±è´¥é—®é¢˜ã€‚
# å…¼å®¹æ€§: é€‚ç”¨äº GNU/Linux å’Œ macOS/BSD ç³»ç»Ÿã€‚
# 
# ç”¨æ³•: 
#   ./emby_db_repair.sh --path /path/to/emby/config
#
# -----------------------------------------------------------------------------------------
# âš ï¸ è­¦å‘Š: 
# 1. è¿è¡Œå‰ã€å¿…é¡»ã€‘æ‰‹åŠ¨åœæ­¢ Emby æœåŠ¡/Docker å®¹å™¨ã€‚
# 2. å»ºè®®ä½¿ç”¨ 'sudo' è¿è¡Œä»¥ç¡®ä¿ chown/chmod æ“ä½œæˆåŠŸã€‚
# =========================================================================================

# é»˜è®¤å˜é‡
EMBY_DIR="/vol1/1000/docker/emby/config" #è¿™æ˜¯æˆ‘é£ç‰›embyæ•°æ®åº“çš„åœ°å€
DB_FILENAME="library.db"
TABLE_PATTERN='fts_search9(_config|_content|_data|_docsize|_idx)?'

# -----------------------------------------------------------------------------------------
# âš™ï¸ è§£æå‘½ä»¤è¡Œå‚æ•°
# -----------------------------------------------------------------------------------------

while [[ $# -gt 0 ]]; do
    case "$1" in
        --path)
            if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
                EMBY_DIR="$2"
                shift 2
            else
                echo "âŒ é”™è¯¯: --path ç¼ºå°‘å‚æ•° (Emby é…ç½®ç›®å½•è·¯å¾„)." >&2
                exit 1
            fi
            ;;
        *)
            echo "âŒ é”™è¯¯: æœªçŸ¥å‚æ•° '$1'" >&2
            echo "ç”¨æ³•: ./emby_db_repair.sh --path /path/to/emby/config" >&2
            exit 1
            ;;
    esac
done

# -----------------------------------------------------------------------------------------
# æ£€æŸ¥ä¸è·¯å¾„ç¡®è®¤
# -----------------------------------------------------------------------------------------

if [ -z "$EMBY_DIR" ]; then
    echo "âŒ è‡´å‘½é”™è¯¯: è¯·ä½¿ç”¨ --path å‚æ•°æŒ‡å®š Emby çš„é…ç½®æ ¹ç›®å½•ã€‚" >&2
    exit 1
fi

# ç¡®ä¿è·¯å¾„ä»¥ /data ç»“å°¾çš„ï¼Œæˆ‘ä»¬å–å…¶çˆ¶ç›®å½•ä½œä¸º EMBY_DIR
# ä¾‹å¦‚ï¼šå¦‚æœç”¨æˆ·è¾“å…¥ /path/to/emby/dataï¼Œåˆ™å°† EMBY_DIR è®¾ä¸º /path/to/emby
if [[ "$EMBY_DIR" == *"/data" ]]; then
    EMBY_DIR=$(dirname "$EMBY_DIR")
fi

# ç¡®ä¿ç›®æ ‡æ•°æ®åº“æ–‡ä»¶å­˜åœ¨
if [ ! -f "$EMBY_DIR/data/$DB_FILENAME" ]; then
    echo "âŒ è‡´å‘½é”™è¯¯: åœ¨è·¯å¾„ '$EMBY_DIR/data/$DB_FILENAME' æœªæ‰¾åˆ°æ•°æ®åº“æ–‡ä»¶ã€‚" >&2
    exit 1
fi

# -----------------------------------------------------------------------------------------
# âš™ï¸ å…¼å®¹æ€§æ£€æŸ¥ä¸å‡½æ•°å®šä¹‰
# -----------------------------------------------------------------------------------------

# æ£€æŸ¥ sqlite3 æ˜¯å¦å®‰è£…
if ! command -v sqlite3 &> /dev/null; then
    echo "âŒ é”™è¯¯: sqlite3 å‘½ä»¤è¡Œå·¥å…·æœªå®‰è£…ã€‚è¯·å…ˆå®‰è£… (ä¾‹å¦‚: sudo apt install sqlite3)ã€‚" >&2
    exit 1
fi

# æ£€æŸ¥ stat å‘½ä»¤ç±»å‹ï¼Œå®šä¹‰å…¼å®¹å‡½æ•°
if stat --version &> /dev/null; then
    # GNU (Linux) æ¨¡å¼
    get_stat() { stat --format "$1" "$2"; }
    sed_fix() { sed -i '$s/^ROLLBACK; -- due to errors/COMMIT;/' "$1"; }
else
    # BSD (macOS/FreeBSD) æ¨¡å¼
    get_stat() { stat -f "$1" "$2"; }
    sed_fix() { sed -i '' '$s/^ROLLBACK; -- due to errors/COMMIT;/' "$1"; }
fi

# -----------------------------------------------------------------------------------------
# ğŸš€ æ ¸å¿ƒä¿®å¤æµç¨‹
# -----------------------------------------------------------------------------------------

echo "--- ä¿®å¤å¼€å§‹ ---"
echo "âœ… ç›®æ ‡ç›®å½•: $EMBY_DIR"

cd "$EMBY_DIR" || exit 1 # åˆ‡æ¢ç›®å½•å¤±è´¥åˆ™é€€å‡º

BACKUP_SQL="data/backup_$(date +%Y%m%d%H%M%S).sql" 
CLEAN_SQL="data/clean.sql"
NEW_DB="data/library_new.db"
DB_PATH="data/$DB_FILENAME"

# æ­¥éª¤ 1: æ£€æŸ¥ACLæƒé™å¹¶å‘å‡ºè­¦å‘Š
if ls -ld "$DB_PATH" | grep -q '+'; then
    echo "âš ï¸ è­¦å‘Š: åŸå§‹æ–‡ä»¶å…·æœ‰ ACL ('+') æƒé™ã€‚è„šæœ¬å°†æ— æ³•å¤åˆ¶ ACLã€‚å¦‚æœé‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¿®å¤æƒé™ã€‚"
fi

# æ­¥éª¤ 2: å¯¼å‡ºåŸå§‹æ•°æ®åº“
echo "--- 2. å¯¼å‡ºåŸå§‹æ•°æ®åº“ ($DB_PATH) ---"
if ! sqlite3 "$DB_PATH" ".dump" > "$BACKUP_SQL"; then
    echo "âŒ è‡´å‘½é”™è¯¯: æ•°æ®åº“å¯¼å‡ºå¤±è´¥ã€‚æœåŠ¡å¯èƒ½æœªåœæ­¢ã€‚" >&2
    exit 1
fi

# æ­¥éª¤ 3: ç§»é™¤ç›®æ ‡è¡¨ (fts_search9)
echo "--- 3. ä»å¤‡ä»½ä¸­ç§»é™¤æŸåçš„è¡¨ ($TABLE_PATTERN) ---"
grep -v -E "$TABLE_PATTERN" "$BACKUP_SQL" > "$CLEAN_SQL"

# æ­¥éª¤ 4: ä¿®æ­£ SQL äº‹åŠ¡
echo "--- 4. ä¿®æ­£ SQL äº‹åŠ¡ï¼š ROLLBACK -> COMMIT ---"
sed_fix "$CLEAN_SQL"

# æ­¥éª¤ 5: ç”Ÿæˆæ–°æ•°æ®åº“
echo "--- 5. ç”Ÿæˆæ–°çš„æ•°æ®åº“ ($NEW_DB) ---"
if ! sqlite3 "$NEW_DB" < "$CLEAN_SQL"; then
    echo "âŒ è‡´å‘½é”™è¯¯: ä» SQL æ–‡ä»¶å¯¼å…¥æ•°æ®å¤±è´¥ã€‚" >&2
    exit 1
fi

# æ­¥éª¤ 6: è·å–å¹¶åº”ç”¨æƒé™å’Œæ‰€æœ‰æƒ
echo "--- 6. è·å–å¹¶åº”ç”¨åŸå§‹æ•°æ®åº“çš„æƒé™å’Œæ‰€æœ‰æƒ ---"
# è·å–æƒé™å’Œæ‰€æœ‰æƒï¼Œä¼˜å…ˆ GNU æ ¼å¼ï¼Œå¤±è´¥åˆ™ä½¿ç”¨ BSD æ ¼å¼
perm=$(get_stat '%a' "$DB_PATH" 2>/dev/null)
owner=$(get_stat '%U:%G' "$DB_PATH" 2>/dev/null)
if [ -z "$owner" ]; then
    owner=$(get_stat '%Su:%Sg' "$DB_PATH")
    perm=$(get_stat '%A' "$DB_PATH")
fi

if ! chmod "$perm" "$NEW_DB" || ! chown "$owner" "$NEW_DB"; then
    echo "âŒ ä¸¥é‡è­¦å‘Š: æƒé™/æ‰€æœ‰æƒåº”ç”¨å¤±è´¥ã€‚è¯·ç¡®ä¿æ‚¨ä½¿ç”¨ 'sudo' è¿è¡Œè„šæœ¬ã€‚" >&2
fi
echo "    -> æƒé™åº”ç”¨: $perm, æ‰€æœ‰è€…åº”ç”¨: $owner"

# æ­¥éª¤ 7: å¤‡ä»½åŸå§‹æ•°æ®åº“å¹¶æ›¿æ¢
echo "--- 7. å¤‡ä»½åŸå§‹æ•°æ®åº“å¹¶æ›¿æ¢ ---"
mv "$DB_PATH" "$DB_PATH.bak"
[ -f "data/library.db-shm" ] && mv "data/library.db-shm" "data/library.db-shm.bak"
[ -f "data/library.db-wal" ] && mv "data/library.db-wal" "data/library.db-wal.bak"

mv "$NEW_DB" "$DB_PATH"

echo "--- âœ… ä¿®å¤å®Œæˆã€‚è¯·é‡å¯ Emby æœåŠ¡ã€‚ ---"
